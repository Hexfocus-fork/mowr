{% extends "layout.html" %}
{% set vote = file['vote_malicious'] + file['vote_clean'] %}
{% block content %}
    {% if file['vote_clean']|int > 0 or file['vote_malicious']|int > 0 %}
        <div class="row">
            <div class="col-lg-9 col-sm-9 col-xs-2">
                <h2>Analysis:</h2>
            </div>
            <div class="col-lg-3 col-sm-3 col-xs-10">
                <span class="center">Users ratio: {{ '{:,.3f}'.format(file['vote_malicious']*100/vote) }}%</span>
                <div class="gauge">
                    <canvas id="gauge-ratio"></canvas>
                    <div class="vote">
                        <div class="vote_malicious">{{ file['vote_malicious'] }}</div>
                        <div class="vote_clean">{{ file['vote_clean'] }}</div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    <table class="table table-bordered">
        <tr>
            <td colspan="2" class="active">File informations</td>
        </tr>
        <tr>
            <td>Name(s)</td>
            <td>{% for i in file['name'] %}{{ i }} {% endfor %}</td>
        </tr>
        <tr>
            <td>MD5</td>
            <td>{{ file['md5'] }}</td>
        </tr>
        <tr>
            <td>Sha256</td>
            <td id="sha256">{{ file['sha256'] }}</td>
        </tr>
        <tr>
            <td>SSDeep</td>
            <td>{{ file['ssdeep'] }}</td>
        </tr>
        <tr>
            <td>MIME</td>
            <td>{{ file['mime'] }}</td>
        </tr>
        <tr>
            <td colspan="2" class="active">Dates</td>
        </tr>
        <tr>
            <td>First analysis</td>
            <td>{{ file['first_analysis'] }} UTC</td>
        </tr>
        <tr>
            <td>Last analysis</td>
            <td>{{ file['last_analysis'] }} UTC</td>
        </tr>
        <tr>
            <td>Tags <a href="#" class="td_add" onclick="showTagForm()"><span
                    class="glyphicon glyphicon-plus-sign"></span></a></td>
            <td>{% for tag in file['tags'] %}
                    {{ formatTag(tag)|safe }}
                {% endfor %}
            </td>
        </tr>
        <tr id="tagform" hidden="hidden">
            <td>Add a tag</td>
            <td>
            <select id="tagtoadd">
                <option>-- Choose a tag in the list --</option>
                {% for tag in tag_list %}
                    {% if tag not in file['tags'] %}
                        <option value="{{ tag }}">{{ tag }}</option>
                    {% endif %}
                {% endfor %}
            </select>
                <button class="btn btn-xs btn-success" onclick="submitTag()">Add</button>
            </td>
        </tr>
        <tr>
            <td colspan="2" class="active">File analysis</td>
        </tr>
        {% for analysis in file['analyzes'] %}
            {% if analysis.type == type %}
                <tr>
                    <td>PMF</td>
                    {% if analysis.pmf_result|length == 0 %}
                        <td>
                            <div class="clean">Clean <span class="glyphicon glyphicon-ok-sign"></span></div>
                        </td>
                    {% else %}
                        <td>{{ analysis.pmf_result }}</td>
                    {% endif %}
                </tr>
            {% endif %}
        {% endfor %}
    </table>

    {% if session.get('can_vote') == file['sha256'] %}
        <div class="alert" id="vote">
            What do you think about this file ?
            <button class="btn btn-success btn-xs" onclick="vote('{{ file['sha256'] }}', 'clean')">Clean</button>
            <button class="btn btn-danger btn-xs" onclick="vote('{{ file['sha256'] }}', 'malicious')">Malicious</button>
        </div>
    {% endif %}
    <div class="container">
        <a href="{{ url_for('default.index') }}"><span class="btn btn-info">Upload a new file</span></a>
    </div>
{% endblock %}
{% block script %}
    {% if file['vote_clean']|int > 0 or file['vote_malicious']|int > 0 %}
        <script src="{{ url_for('static', filename='js/gauge.min.js') }}"></script>
        <script>
            var opts = {
                lines: 12, // The number of lines to draw
                angle: 0, // The length of each line
                lineWidth: 0.2, // The line thickness
                pointer: {
                    length: 0.51, // The radius of the inner circle
                    strokeWidth: 0.033, // The rotation offset
                    color: '#000000' // Fill color
                },
                limitMax: 'false',   // If true, the pointer will not go past the end of the gauge
                colorStart: '#690202',   // Colors
                colorStop: '#D10000',    // just experiment with them
                strokeColor: '#10C778',   // to see which ones work best for you
                generateGradient: true
            };
            var target = document.getElementById('gauge-ratio'); // your canvas element
            var gauge = new Gauge(target).setOptions(opts); // create sexy gauge!
            gauge.maxValue = {{ vote }}; // set max gauge value
            gauge.animationSpeed = 27; // set animation speed (32 is default value)
            gauge.set({{ file['vote_malicious'] }}); // set actual value
        </script>
    {% endif %}
{% endblock %}
